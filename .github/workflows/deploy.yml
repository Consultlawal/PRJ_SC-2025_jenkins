name: Deploy Hipster Shop with Security

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-and-secure:
    runs-on: ubuntu-latest

    env:
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # ------------------- Setup -------------------
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.27.3'

    - name: Decode kubeconfig
      run: |
        echo "$KUBE_CONFIG_DATA" | base64 --decode > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    # ------------------- Deploy Application -------------------
    - name: Deploy Hipster Shop
      run: |
        kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/microservices-demo/main/release/kubernetes-manifests.yaml

    # ------------------- Install Kyverno -------------------
    - name: Install Kyverno
      run: |
        kubectl create namespace kyverno || true
        kubectl apply -f https://raw.githubusercontent.com/kyverno/kyverno/main/config/release/install.yaml

    # ------------------- Apply Kyverno Policies -------------------
    - name: Apply Kyverno policies
      run: |
        echo "Applying all policies in kyverno-policies/"
        kubectl apply -f kyverno-policies/

    # ------------------- Install Trivy Operator -------------------
    - name: Install Trivy Operator
      run: |
        helm repo add aqua https://aquasecurity.github.io/helm-charts/
        helm repo update
        kubectl create namespace trivy-system || true
        helm install trivy-operator aqua/trivy-operator -n trivy-system

    # ------------------- Run Trivy scan -------------------
    - name: Scan deployed pods with Trivy
      run: |
        echo "Running vulnerability scan..."
        kubectl get vulnerabilities -A || true

