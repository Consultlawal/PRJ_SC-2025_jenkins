name: Deploy Hipster Shop with Security

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-and-secure:
    runs-on: ubuntu-latest

    env:
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}

    steps:
    # ------------------- Checkout Repo -------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # ------------------- Trivy SAST Scan -------------------
    - name: Trivy SAST Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        severity: 'HIGH,CRITICAL'

    # ------------------- Setup Kubernetes CLI -------------------
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.27.3'

    - name: Decode kubeconfig
      run: |
        echo "$KUBE_CONFIG_DATA" | base64 --decode > $HOME/.kube/config
        chmod 600 $HOME/.kube/config

    # ------------------- Deploy Hipster Shop -------------------
    - name: Deploy Hipster Shop
      run: |
        kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/microservices-demo/main/release/kubernetes-manifests.yaml

    # ------------------- Install Kyverno -------------------
    - name: Install Kyverno
      run: |
        kubectl create namespace kyverno || true
        kubectl apply -f https://raw.githubusercontent.com/kyverno/kyverno/main/config/release/install.yaml

    # ------------------- Install OPA Gatekeeper -------------------
    - name: Install OPA Gatekeeper
      run: |
        kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml
        kubectl -n gatekeeper-system rollout status deployment/gatekeeper-controller-manager

    # ------------------- Apply Kyverno Policies -------------------
    - name: Apply Kyverno policies
      run: |
        echo "Applying Kyverno policies..."
        kubectl apply -f kyverno-policies/

    # ------------------- Install Trivy Operator -------------------
    - name: Install Trivy Operator
      run: |
        helm repo add aqua https://aquasecurity.github.io/helm-charts/
        helm repo update
        kubectl create namespace trivy-system || true
        helm install trivy-operator aqua/trivy-operator -n trivy-system

    # ------------------- Run Vulnerability Scan -------------------
    - name: Scan deployed pods with Trivy
      run: |
        echo "Running cluster vulnerability scan..."
        kubectl get vulnerabilities -A || true
